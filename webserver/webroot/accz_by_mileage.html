<html>
<head>
<title>PiRail Chart Example</title>
<script src="js/chart-3.6.0.js"></script>
<script src="js/jquery-3.6.0.js"></script>
</head>
<body>
<input type=text id="file" value="wrr_20211016_with_mileage_sort_by_time.json"><br>
<input type=text id="startmileage" value="1"><br>
<input type=text id="endmileage" value="4.5"><br>
<input type=text id="percentile" value="0.999"><br>
<canvas id="myChart" width="400" height="400"></canvas>
<script>

function plot_data(result) {
  // Find an average reading to normallize the data
  accsum = 0;
  acccnt = 0;
  for (let i = 0; i < result.length; i++) {
    if (result[i].class == "ATT") {
      accsum += result[i].acc_z;
      acccnt += 1;
    }
  }
  accavg = accsum / acccnt;
  console.log("average =", accavg);

  // calculate the noisefloor
  bins = [];
  for (let i = 0; i < result.length; i++) {
    if (result[i].class == "ATT") {
      bins.push(result[i].acc_z - accavg);
    }
  }

  bins.sort(function(a,b){return a-b;});
  index = Math.floor(
    parseFloat(document.getElementById('percentile').value) * bins.length);
  noisefloor = bins[index];
  console.log("noisefloor =", index, "of", bins.length);

  // convert the JSON to arrays for JChart
  values = [];
  labels = [];

  // only plot above the noise floor
  for (let i = 0; i < result.length; i++) {
    if (result[i].class == "ATT") {
      if (result[i].acc_z > noisefloor) {
        values.push(result[i].acc_z);
        labels.push(result[i].mileage);
      }
    }
  }

  // Setup JChart Data
  const data = {
    labels: labels,
    datasets: [{
      label: "ACC_Z",
      data: values,
    }]
  };

  // Plot the chart
  const ctx = document.getElementById('myChart').getContext('2d');
  const myChart = new Chart(ctx, {
    type: 'scatter',
    data: data,
  })
}

$.ajax({
  type: "GET",
  dataType: "json",
  headers: {"Accept": "application/json"},
  url: "/data/" +
    document.getElementById('file').value +
    "?xform=thin&start-mileage=" +
    document.getElementById('startmileage').value +
    "&end-mileage=" +
    document.getElementById('endmileage').value,
  success: plot_data,
});
</script>
</body>
</html>
