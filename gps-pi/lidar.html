<!DOCTYPE html>
<html>
<head>
	<title>RPi/LIDAR</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script type="text/javascript" src="/jquery-3.4.1.min.js"></script>
</head>
<body>
<h1>LIDAR</h1>
<button onclick="window.location.href='/gps.html'">GPS</button>
<button onclick="window.location.href='/setup.html'">SETUP</button>
<table>
<tr><td id="msg">Loading...</td></tr>
<tr><td><canvas id="viewport" width="512" height="512"></canvas></td></tr>
</table>
<script>
var refresh=1000;
var scale=0.1;
var decay=10;
function do_update(name, imagedata)
{
	$.ajax({
		datatype: "json",
		url: "/lidar",
		success: function(obj) {
			update(name, imagedata, obj);
			setTimeout(do_update, refresh, name, imagedata);
		},
		error: function(xhr, status, error) {
			$('#msg').html("&#x274C; Connection Error");
			setTimeout(do_update, refresh, name, imagedata);
		}
	});
}
function setup(name) {
	var canvas = document.getElementById(name);
	var context = canvas.getContext("2d");
	return context.createImageData(canvas.width, canvas.height);
}
function update(name, imagedata, obj) {
	var canvas = document.getElementById(name);
	var context = canvas.getContext("2d");

	for (var i=0; i<canvas.width*canvas.height*4; i += 4) {
		if (imagedata.data[i] < 255) {
		    imagedata.data[i] = Math.min(imagedata.data[i] + decay, 255);
		}
		if (imagedata.data[i+1] < 255) {
		    imagedata.data[i+1] = Math.min(imagedata.data[i+1] + decay, 255);
		}
		if (imagedata.data[i+2] < 255) {
		    imagedata.data[i+2] = Math.min(imagedata.data[i+2] + decay, 255);
		}
	}

	for (var i=0; i<obj.scan.length; i++) {
		a = obj.scan[i][0];
		d = obj.scan[i][1] * scale;
		x = Math.round(d * Math.sin(a*0.0174533) + canvas.width / 2);
		if (x < 0) {
			x = 0;
		} else if (x >= canvas.width) {
			x = canvas.width - 1;
		}
		y = Math.round(-d * Math.cos(a*0.0174533) + 0.75 * canvas.height);
		if (y < 0) {
			y = 0;
		} else if (y >= canvas.height) {
			y = canvas.height - 1 ;
		}
		pixel = (y * canvas.width + x) * 4;
		imagedata.data[pixel] = 0;
		imagedata.data[pixel+1] = 0;
		imagedata.data[pixel+2] = 0;
		imagedata.data[pixel+3] = 255;
	}
	context.putImageData(imagedata, 0, 0);
}
$(document).ready(function()
{
	imagedata = setup("viewport");
	do_update("viewport", imagedata);
});

	</script>
</body>
</html>
