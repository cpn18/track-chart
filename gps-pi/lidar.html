<!DOCTYPE html>
<html>
<head>
	<title>RPi/LIDAR</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script type="text/javascript" src="/jquery-3.4.1.min.js"></script>
</head>
<body>
	<table>
		<tr><td id="msg">Loading...</td></tr>
		<tr><td><canvas id="viewport" width="512" height="512"></canvas></td></tr>
	</table>
	<script>
var refresh=1000;
var scale=0.1;
var scanline=0;
function do_update(name, imagedata)
{
	$.ajax({
		datatype: "json",
		url: "/lidar",
		success: function(obj) {
			update(name, imagedata, obj);
			setTimeout(do_update, refresh, name, imagedata);
		},
		error: function(xhr, status, error) {
			$('#msg').html("&#x274C; Connection Error");
			setTimeout(do_update, refresh, name, imagedata);
		}
	});
}
function setup(name) {
	var canvas = document.getElementById(name);
	var context = canvas.getContext("2d");
	return context.createImageData(canvas.width, canvas.height);
}
function update(name, imagedata, obj) {
	var canvas = document.getElementById(name);
	var context = canvas.getContext("2d");

	//for (var pixel=0; pixel<canvas.height*canvas.width*4; pixel++) {
//		imagedata.data[pixel] = 0;
	//}
	pixel = scanline * canvas.width * 4
	for (var i=0; i<3*canvas.width; i++) {
		imagedata.data[pixel] = 255;
		imagedata.data[pixel+1] = 255;
		imagedata.data[pixel+2] = 255;
		imagedata.data[pixel+3] = 255;
		pixel = pixel + 4;
	}
	scanline = scanline + 3;
	if (scanline == canvas.height) {
		scanline = 0;
	}
	for (var i=0; i<obj.scan.length; i++) {
		a = obj.scan[i][0];
		d = obj.scan[i][1] * scale;
		x = Math.round(d * Math.sin(a*0.0174533) + canvas.width / 2);
		if (x < 0) {
			x = 0;
		} else if (x >= canvas.width) {
			x = canvas.width - 1;
		}
		y = Math.round(-d * Math.cos(a*0.0174533) + 0.75 * canvas.height);
		if (y < 0) {
			y = 0;
		} else if (y >= canvas.height) {
			y = canvas.height - 1 ;
		}
		pixel = (y * canvas.width + x) * 4;
		imagedata.data[pixel] = 0;
		imagedata.data[pixel+1] = 0;
		imagedata.data[pixel+2] = 0;
		imagedata.data[pixel+3] = 255;
	}
	context.putImageData(imagedata, 0, 0);
}
$(document).ready(function()
{
	imagedata = setup("viewport");
	do_update("viewport", imagedata);
});

	</script>
</body>
</html>
