<!DOCTYPE html>
<html>
<head>
	<title>PiRail LIDAR Status</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script type="text/javascript" src="/jquery-3.4.1.min.js"></script>
</head>
<body>
<h1>LIDAR</h1>
<button onclick="window.location.href='/index.html'">&#x1f3e0;HOME</button>
<button onclick="window.location.href='/setup.html'">&#x2699;SETUP</button>
<button onclick="window.location.href='/gps.html'">&#x1f6f0;GPS</button>
<button onclick="window.location.href='/imu.html'">&#x1f4f3;IMU</button>
<!-- <button onclick="window.location.href='/lidar.html'">&#x26a1;LIDAR</button> --!>
<button onclick="window.location.href='/lpcm.html'">&#x1f3a4;LPCM</button>
<table>
<tr><td id="msg">Loading...</td></tr>
<tr><td><canvas id="viewport" width="512" height="512"></canvas></td></tr>
</table>
<script>
var refresh=1000;
var scale=0.1;
var decay=10;
function do_update(name, imagedata)
{
	$.ajax({
		datatype: "json",
		url: "/lidar",
		success: function(obj) {
			$('#msg').html(obj.time.replace('T', ' '));
			update(name, imagedata, obj);
			setTimeout(do_update, refresh, name, imagedata);
		},
		error: function(xhr, status, error) {
			$('#msg').html("&#x274C; Connection Error " + error);
			setTimeout(do_update, refresh, name, imagedata);
		}
	});
}
function setup(name) {
	var canvas = document.getElementById(name);
	var context = canvas.getContext("2d");
	return context.createImageData(canvas.width, canvas.height);
}

function update(name, imagedata, obj) {
	var canvas = document.getElementById(name);
	var context = canvas.getContext("2d");
	var last_x = 0;
	var last_y = 0;

	for (var i=0; i<canvas.width*canvas.height*4; i += 4) {
	    for (var j=0; j < 3; j++) {
		if (imagedata.data[i+j] < 255) {
		    imagedata.data[i+j] = Math.min(imagedata.data[i+j] + decay, 255);
		}
	    }
	}

	last_x = 0;
	last_y = 0;

	// center
	x = Math.round(canvas.width / 2);
	y = Math.round(0.75 * canvas.height);
	pixel = (y * canvas.width + x) * 4;
	imagedata.data[pixel] = 0;
	imagedata.data[pixel+1] = 255;
	imagedata.data[pixel+2] = 0;
	imagedata.data[pixel+3] = 255;

	for (var i=0; i<obj.scan.length; i++) {
		a = obj.scan[i][0];
		d = obj.scan[i][1] * scale;
		x = Math.round(d * Math.sin(a*0.0174533) + canvas.width / 2);
		y = Math.round(-d * Math.cos(a*0.0174533) + 0.75 * canvas.height);

		if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) {
			continue;
		}

		pixel = (y * canvas.width + x) * 4;
		imagedata.data[pixel] = 0;
		imagedata.data[pixel+1] = 0;
		imagedata.data[pixel+2] = 0;
		imagedata.data[pixel+3] = 255;

		dx = last_x - x;
                dy = last_y - y;
		distance = Math.sqrt(dx*dx+dy*dy);
		if (distance < d*0.05) {
		   if ( Math.abs(dx) > Math.abs(dy) ) {
		     if (x > last_x) {
			   start_x = last_x;
			   end_x = x;
			   start_y = last_y;
			   end_y = y;
	             } else {
			   start_x = x;
			   end_x = last_x;
			   start_y = y;
			   end_y = last_y;
                     }
		     dx = end_x - start_x;
                     dy = end_y - start_y;
                     for (tx = start_x, ty = start_y; tx < end_x; tx++, ty += dy/dx) {
		       pixel = (Math.round(ty) * canvas.width + tx) * 4;
		       imagedata.data[pixel] = 0;
		       imagedata.data[pixel+1] = 0;
		       imagedata.data[pixel+2] = 255;
		       imagedata.data[pixel+3] = 255;
	             }
                   } else {
		     if (y > last_y) {
		       start_x = last_x;
		       end_x = x;
		       start_y = last_y;
		       end_y = y;
	             } else {
		       start_x = x;
		       end_x = last_x;
		       start_y = y;
		       end_y = last_y;
                     }
		     dx = end_x - start_x;
                     dy = end_y - start_y;
          	     for (ty = start_y, tx = start_x; ty < end_y; ty++, tx += dx/dy) {
		       pixel = (ty * canvas.width + Math.round(tx)) * 4;
		       imagedata.data[pixel] = 0;
		       imagedata.data[pixel+1] = 0;
		       imagedata.data[pixel+2] = 255;
		       imagedata.data[pixel+3] = 255;
		     }
                  }
                }
		
		last_x = x;
		last_y = y;
	}
	context.putImageData(imagedata, 0, 0);
}
$(document).ready(function()
{
	imagedata = setup("viewport");
	do_update("viewport", imagedata);
});

	</script>
</body>
</html>
